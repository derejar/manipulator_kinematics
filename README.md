# Решение прямой и обратной задач кинематики
[Описание робота-манипулятора](#описание-робота-манипулятора)  \
[Функционал программы](#функционал-программы)  \
[Решение прямой задачи кинематики](#решение-прямой-задачи-кинематики)  \
[Решение обратной задачи кинематики](#решение-обратной-задачи-кинематики) 

## Описание робота-манипулятора
Манипулятор имеет два плеча длинной 370 и 440 миллиметров, угол наклона которых может меняться относительно пола и друг друга. 
Изменение углов наклона осуществляется при помощи двух шаговых двигателей. Помимо этого, робот может вращаться вокруг своей оси при помощи третьего шагового двигателя.
Робот имеет следующие конструктивные ограничения:

  - Робот не может вращаться вокруг своей оси более, чем на 70 градусов.
  - Угол между первым плечом и полом не может меньше 20 и больше 60 градусов.
  - Угол между первым и вторым плечом не может быть меньше 55 и больше 125 градусов.

Робот основан на Arduino Mega 2560, трех шаговых двигателях и драйверах шаговых двигателей - два драйвера L298N и один драйвер A3967 EasyDriver v.4.4.
<p align="center">
  <image src="https://github.com/user-attachments/assets/c2383def-4212-4816-8db7-3818432bade2" alt="manipulator" width="558" height="419"></image>
</p>

## Функционал программы
Управление роботом осуществляется по протоколу UART. Поскольку в данной конфигурации информация передается побайтово, то каждая команда представляет 
собой один байт - символ или цифру. Доступны следующие команды:
  - f - решает прямую задачу кинематики и возвращает координаты, в которых в текущий момент находится клешня манипулятора.
  - i - решает обратную задачу кинематики на основании заданных координат и, если эти координаты достижимы, начинает перемещать клешню манипулятора в требуемые координаты.
Если же координаты недостижимы, то сообщает об этом и не предпринимает никаких действий.
  - x/y/z - указывает, какую координату пользователь желает задать в текущий момент. При выполнении данной команды предыдущее значение координаты обнуляется.
  - p - выводит текущие значения координат x/y/z (то есть координаты, в которые ПЛАНИРУЕТСЯ перемещаться).
  - 1/2/3/4/5/6/7/8/9/0 - значение добавляется в конец задаваемой в текущий момент координаты (эквивалентно, например, x*10 + d, где d - это введенная цифра).
  - "\-" - инвертирует значение координаты, задаваемой в текущий момент.

Например, для того, чтобы переместить клешню манипулятора в точку (630; 435; 0), нужно выполнить следующую последовательность команд: `x630y345z0i`.
Или, чтобы переместить клешню манипулятора в точку (88; -296; 230), нужно выполнить следующую последовательность: `x88y296-z230i`.

## Решение прямой задачи кинематики
Целью прямой задачи кинематики является вычисление координат клешни на основании известных углов наклона плеч робота-манипулятора. Дано:

  - А = 370 миллиметров - длина первого плеча манипулятора;
  - B = 440 миллиметров - длина второго плеча манипулятора;
  - α - угол наклона первого плеча манипулятора относительно пола;
  - β - угол наклона второго плеча манипулятора относительно первого (иными словами - угол между первым и вторым плечами манипулятора);
  - γ - угол поворота робота вокруг своей оси.

Манипулятор функционирует в трехмерном пространстве. Для решения прямой задачи кинематики, сначала рассмотрим манипулятор в плоскости xz:

<p align="center">
  <image src="https://github.com/user-attachments/assets/b213e118-88c8-4c27-994c-135ecda3d1ad" alt="forwardkinematicxz" width="403" height="338"> </image>
</p>

Координаты для точки M можно вычислить следующим образом:
    
``` math
\begin{gather}
x_{1} = x_{2}*cos(\gamma); \\
z_{1} = x_{2}*sin(\gamma);
\end{gather}
```

Теперь рассмотрим манипулятор в плоскости xy:
<p align="center">
  <image src="https://github.com/user-attachments/assets/1c9f792f-21d7-4435-a598-18c2541d5382" alt="forwardkinematicxy" width="512" height="303"></image>
</p>

Для начала рассчитаем координаты $$y_{1}$$ по следующей формуле:
``` math
y_{1} = A*sin(\alpha);
```
Для рассчета координаты $$y_{2}$$ нужно учитывать то, что в зависимости от значения угла $$\beta$$, значение координаты $$y_{2}$$ может оказаться как больше $$y_{1}$$, 
так и меньше. Чтобы это учесть, посчитаем угол $$\Delta$$ относительно прямой G по следующей формуле: 
``` math
\Delta = \alpha + \beta - 180^{\circ};
```
Теперь $$y_{2}$$ можно посчитать так: 
``` math
y_{2} = y_{1} + B * sin(\Delta);
```
Теперь рассчитаем значение координаты $$x_{1}$$:
``` math
x_{1} = A * cos(\alpha); 
```
Теперь, зная $$x_{1}$$, можно рассчитать $$x_{2}$$:

``` math 
x_{2} = x_{1} + B * cos(\Delta);
```

Таким образом, подводя итоги всему вышеописанному, решение задачи прямой кинематики в данном случае будет иметь следующий вид:

``` math
\left\{\begin{array}{l}
x = cos(\gamma) * (A * cos(\alpha) + B * cos(\Delta)) \\ 
y = A * sin(\alpha) + B * sin(\Delta) \\ 
z = sin(\gamma) + (A * cos(\Delta))
\end{array}\right.
```

## Решение обратной задачи кинематики
Целью обратной задачи кинематики является вычисление углов наклона плеч робота-манипулятора на основе предоставленных координат. Дано:

  - А = 370 миллиметров - длина первого плеча манипулятора;
  - B = 440 миллиметров - длина второго плеча манипулятора;
  - x, y, z - координаты точки, для которой требуется рассчитать углы наклона плеч манипулятора.

Рассмотрим манипулятор в плоскости xz:

<p align="center">
  <image src="https://github.com/user-attachments/assets/a940b151-23af-486b-a168-061ddbad327d" alt="inversekinematicxz" width="342" height="305"></image>
</p>

Вычислим длину отрезка R:

``` math
R = \sqrt{x_{1}^2 + z_{1}^2};
```

Тогда угол $$\gamma$$ можно рассчитать следующим образом:

``` math
cos(\gamma) = \frac{x_{1}}{R} \Rightarrow \gamma = arccos \left( \frac{x_{1}}{R} \right);
```
Теперь рассмотрим плоскость xy:

<p align="center">
  <image src="https://github.com/user-attachments/assets/1cb6badf-f72a-4a4c-a980-c70ebcb8f848" alt="inversekinematicxy" width="452" height="303"></image>
</p>

Длину прямой L можно рассчитать так:

``` math
L = \sqrt{x_{1}^2 + y_{1}^2 + z_{1}^2};
```

Теперь, исходя из теоремы косинусов, можно рассчитать угол $$\beta$$:

``` math
cos(\beta) = \frac{A^2 + B^2 - L^2}{2*A*B} \Rightarrow \beta = arccos \left( \frac{A^2 + B^2 - L^2}{2*A*B} \right);
```

Угол $$\alpha$$ может рассчитываться двумя способами, в зависимости от того, является ли координата y отрицательной.  \
Первый вариант был показан на последнем рисунке. В этом случае, угол $$\alpha$$ будет рассчитан путем суммирования углов ε и $$\Delta$$.  \
Второй вариант показан на рисунке ниже.

<p align="center">
  <image src="https://github.com/user-attachments/assets/f40316f6-cdbc-4e3a-9f94-3568d8d53d51" alt="inversekinematicxy" width="456" height="355"></image>
</p>

В этом случае, угол будет рассчитан как разница углов ε и $$\Delta$$.  \
Рассчитаем угол ε следующим образом:

``` math
cos(ε) = \frac{A^2 + L^2 - B^2}{2*A*L} \Rightarrow ε = arccos \left( \frac{A^2 + L^2 - B^2}{2*A*L} \right);
```

Угол $$\Delta$$ можно рассчитать так:

``` math
cos(\Delta) = \frac{R}{L} \Rightarrow \Delta = arccos \left( \frac{R}{L} \right);
```

Таким образом, решение задачи обратной кинематики будет выглядеть следующим образом:

``` math
\left\{\begin{array}{l}
\alpha = ε \pm \Delta \\ 
\beta = arccos \left( \frac{A^2 + B^2 - L^2}{2*A*B} \right) \\ 
\gamma = arccos \left( \frac{x_{1}}{R} \right)
\end{array}\right.
```
